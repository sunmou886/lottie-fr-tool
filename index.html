<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lottie åŠ¨ç”»ä¿®å¤ä¸å¸§ç‡ä¿®æ”¹å·¥å…·</title>
  
  <style>
    :root {
      --bg: #f7f6f3;
      --card: #ffffff;
      --text: #2b2b2b;
      --accent: #46473E;
      --line: #e9e7e2;
    }

    html, body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    /* --- Loading é®ç½©å±‚ (æ ¸å¿ƒä¿®å¤) --- */
    .loading-overlay {
      position: fixed; inset: 0; z-index: 9999;
      background: rgba(255, 255, 255, 0.6);
      backdrop-filter: saturate(180%) blur(4px);
      /* é»˜è®¤æ˜¯ flexï¼Œä½†åœ¨ hidden æ—¶å¿…é¡»éšè— */
      display: flex; 
      align-items: center; justify-content: center;
      transition: opacity 0.3s;
    }
    
    /* ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘å¼ºåˆ¶éšè—å±æ€§ç”Ÿæ•ˆï¼Œè¦†ç›– display: flex */
    .loading-overlay[hidden] {
      display: none !important;
    }

    .loading-box {
      background: #fff; padding: 16px 24px; border-radius: 16px;
      border: 1px solid rgba(0,0,0,0.1);
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      display: flex; align-items: center; gap: 12px;
    }
    .spinner {
      width: 20px; height: 20px; border-radius: 50%;
      border: 2.5px solid #e1e1e1; border-top-color: #333;
      animation: spin 0.8s linear infinite;
    }
    .loading-text { font-weight: 600; font-size: 14px; color: #333; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* --- å¸ƒå±€æ ·å¼ --- */
    .wrap { max-width: 1000px; margin: 40px auto; padding: 0 20px; }
    
    .card { 
      background: #fff; border-radius: 24px; padding: 24px; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.02); margin-bottom: 20px;
    }

    /* ä¸Šä¼ åŒº */
    .upload-box {
      border: 2px dashed var(--line); border-radius: 16px; height: 160px;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      cursor: pointer; transition: all 0.2s; position: relative;
    }
    .upload-box:hover, .upload-box.dragover { background: #fafafa; border-color: #ccc; }
    .upload-btn {
      background: var(--accent); color: #fff; padding: 10px 24px; border-radius: 10px;
      font-size: 14px; font-weight: 600; margin-bottom: 12px; pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€åˆ°çˆ¶çº§ */
    }
    .upload-tip { color: #999; font-size: 12px; }
    input[type="file"] { display: none; }

    /* æ’­æ”¾å™¨å¯¹æ¯” */
    .players { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .player-col { background: #fafafa; border-radius: 16px; overflow: hidden; border: 1px solid var(--line); }
    .player-head { 
      padding: 10px 14px; background: #fff; border-bottom: 1px solid var(--line);
      display: flex; justify-content: space-between; align-items: center;
    }
    .p-title { font-size: 12px; font-weight: 700; color: #666; }
    .btns { display: flex; gap: 6px; }
    .btn-xs { 
      border: 1px solid var(--line); background: #fff; border-radius: 6px; 
      padding: 4px 8px; font-size: 11px; cursor: pointer; color: #444;
    }
    .btn-xs:hover { background: #f0f0f0; }

    .stage { 
      height: 300px; background: #fff;
      /* é€æ˜èƒŒæ™¯ç½‘æ ¼ */
      background-image: conic-gradient(#eee 25%, #fff 0 50%, #eee 0 75%, #fff 0);
      background-size: 20px 20px;
    }

    /* åº•éƒ¨æ§åˆ¶æ  */
    .controls { display: flex; gap: 20px; flex-wrap: wrap; align-items: flex-end; }
    
    .input-group { display: flex; flex-direction: column; gap: 8px; flex: 1; }
    .label { font-size: 12px; font-weight: 600; color: #666; }
    
    .fps-input {
      padding: 0 12px; height: 40px; border-radius: 10px; border: 1px solid var(--line);
      font-size: 14px; width: 100%; box-sizing: border-box;
    }

    .pill-group { display: flex; gap: 8px; }
    .pill {
      padding: 8px 16px; border-radius: 10px; font-size: 13px; background: #f0f0f0; color: #666;
      cursor: pointer; border: 1px solid transparent; user-select: none;
    }
    .pill.active { background: #dceecf; color: #3b5226; border-color: #bed6aa; font-weight: 600; }

    .action-btn {
      height: 42px; padding: 0 24px; background: var(--accent); color: #fff;
      border: none; border-radius: 10px; font-weight: 600; cursor: pointer;
    }
    .action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .download-btn {
      width: 100%; height: 48px; background: #222; color: #fff; border-radius: 12px;
      font-weight: 600; margin-top: 16px; border: none; cursor: pointer;
    }
    .download-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* ç®€å•çš„ Toast */
    .toast {
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-20px);
      background: rgba(0,0,0,0.8); color: #fff; padding: 8px 16px; border-radius: 20px;
      font-size: 13px; opacity: 0; transition: all 0.3s; pointer-events: none;
    }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
  </style>

  <script src="https://cdn.staticfile.org/lottie-web/5.12.2/lottie.min.js"></script>
</head>

<body>

  <div class="loading-overlay" id="loadingOverlay" hidden>
    <div class="loading-box">
      <div class="spinner"></div>
      <div class="loading-text">å¤„ç†ä¸­...</div>
    </div>
  </div>

  <div class="wrap">
    <div style="margin-bottom: 24px;">
      <h2 style="margin:0 0 8px 0;">âš¡ Lottie åŠ¨ç”»ä¿®å¤ä¸ FPS ä¿®æ”¹</h2>
      <div style="color:#888; font-size:13px;">æ”¯æŒè‡ªåŠ¨ä¿®å¤å®½é«˜ä¸º 0 çš„å¼‚å¸¸å±‚ã€è°ƒæ•´å¸§ç‡å¹¶ä¿æŒé€Ÿåº¦</div>
    </div>

    <div class="card" style="padding: 10px;">
      <div class="upload-box" id="uploadBox">
        <div class="upload-btn">é€‰æ‹© JSON æ–‡ä»¶</div>
        <div class="upload-tip">æˆ–å°†å…¶æ‹–æ‹½è‡³æ­¤åŒºåŸŸ</div>
        <input type="file" id="fileInput" accept=".json,application/json">
      </div>
    </div>

    <div class="card">
      <div class="players">
        <div class="player-col">
          <div class="player-head">
            <span class="p-title">åŸå§‹æ–‡ä»¶ <span id="info1" style="font-weight:400;margin-left:5px"></span></span>
            <div class="btns">
              <button class="btn-xs" onclick="anim1?.play()">æ’­</button>
              <button class="btn-xs" onclick="anim1?.pause()">åœ</button>
            </div>
          </div>
          <div id="stage1" class="stage"></div>
        </div>
        <div class="player-col">
          <div class="player-head">
            <span class="p-title">ä¿®æ”¹å <span id="info2" style="font-weight:400;margin-left:5px"></span></span>
            <div class="btns">
              <button class="btn-xs" onclick="anim2?.play()">æ’­</button>
              <button class="btn-xs" onclick="anim2?.pause()">åœ</button>
            </div>
          </div>
          <div id="stage2" class="stage"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="controls">
        <div class="input-group" style="flex:2;">
          <div class="label">å¤„ç†æ¨¡å¼</div>
          <div class="pill-group" id="modeGroup">
            <div class="pill active" data-mode="scale">ç¼©æ”¾æ—¶é—´ (ä¿æŒé€Ÿåº¦)</div>
            <div class="pill" data-mode="fps">ä»…æ”¹ FPS (å˜å¿«/æ…¢)</div>
            <div class="pill" data-mode="fix">ä»…ä¿®å¤å¼‚å¸¸</div>
          </div>
        </div>
        
        <div class="input-group">
          <div class="label">ç›®æ ‡å¸§ç‡</div>
          <input type="number" id="fpsInput" class="fps-input" placeholder="ä¾‹å¦‚ 60">
        </div>

        <button id="applyBtn" class="action-btn" disabled>åº”ç”¨</button>
      </div>

      <button id="dlBtn" class="download-btn" disabled>ä¸‹è½½æ–‡ä»¶</button>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // é¡µé¢åŠ è½½å®Œæ¯•å¼ºåˆ¶éšè— Loadingï¼Œé˜²æ­¢å¡æ­»
    window.addEventListener('load', () => {
      document.getElementById('loadingOverlay').hidden = true;
    });

    const $ = id => document.getElementById(id);
    const loadingEl = $('loadingOverlay');
    const toastEl = $('toast');
    
    let originalData = null;
    let processedData = null;
    let anim1 = null, anim2 = null;
    let fileName = 'lottie.json';

    // UI Helper
    const showLoading = (txt) => { 
      loadingEl.querySelector('.loading-text').innerText = txt; 
      loadingEl.hidden = false; 
    };
    const hideLoading = () => { loadingEl.hidden = true; };
    const showToast = (txt) => {
      toastEl.innerText = txt; toastEl.classList.add('show');
      setTimeout(() => toastEl.classList.remove('show'), 2000);
    }

    // --- æ ¸å¿ƒé€»è¾‘ ---

    // 1. è‡ªåŠ¨ä¿®å¤å®½é«˜é€»è¾‘
    function autoFix(json) {
      if (!json) return;
      const mainW = json.w || 500;
      const mainH = json.h || 500;
      let count = 0;

      const fixItem = (item) => {
        // æ£€æŸ¥ assets å’Œ layers
        if ((item.w === 0 || !item.w) && item.ty !== undefined) { 
          item.w = mainW; item.h = mainH; count++; 
        }
      };

      if (json.assets) {
        json.assets.forEach(a => {
          if (!a.w || a.w === 0) { a.w = mainW; a.h = mainH; count++; }
        });
      }
      
      // é€’å½’ä¿®å¤ Layer (ç®€å•ç‰ˆï¼Œä¸»è¦é’ˆå¯¹é¡¶å±‚å’Œä¸€çº§å­å±‚)
      if (json.layers) {
        json.layers.forEach(l => {
          // å¦‚æœæ˜¯ Solid(1) æˆ– Precomp(0) ä¸”æ— å®½é«˜
          if ((l.ty === 1 || l.ty === 0) && (!l.w || l.w === 0)) {
            l.w = mainW; l.h = mainH; count++;
          }
        });
      }
      return count;
    }

    // 2. æ—¶é—´ç¼©æ”¾é€»è¾‘
    function scaleTime(obj, factor) {
      if (typeof obj !== 'object' || obj === null) return;
      
      // å…³é”®å¸§ T å€¼
      if (obj.t !== undefined && typeof obj.t === 'number' && !obj.ty) { // ç®€å•æ’é™¤æ¸å˜ç­‰éæ—¶é—´å±æ€§
         // ç²—ç•¥åˆ¤æ–­æ˜¯å¦æ˜¯å…³é”®å¸§å¯¹è±¡
         if (obj.s || obj.e || obj.hold) obj.t *= factor;
      }
      // æ•°ç»„ä¸­çš„ keyframes
      if (Array.isArray(obj.k)) {
        obj.k.forEach(k => { if (typeof k.t === 'number') k.t *= factor; });
      }
      
      // å±‚çš„å‡ºå…¥ç‚¹
      if (obj.ip !== undefined) obj.ip *= factor;
      if (obj.op !== undefined) obj.op *= factor;
      if (obj.st !== undefined) obj.st *= factor;

      // é€’å½’
      Object.keys(obj).forEach(key => {
        if (typeof obj[key] === 'object') scaleTime(obj[key], factor);
      });
    }

    // --- äº¤äº’é€»è¾‘ ---

    $('uploadBox').onclick = () => $('fileInput').click();
    
    $('fileInput').onchange = (e) => {
      const f = e.target.files[0];
      if (!f) return;
      fileName = f.name;
      showLoading('è¯»å–ä¸­...');
      
      const reader = new FileReader();
      reader.onload = (ev) => {
        try {
          originalData = JSON.parse(ev.target.result);
          
          // æ¸²æŸ“å·¦ä¾§
          if (anim1) anim1.destroy();
          $('stage1').innerHTML = '';
          anim1 = lottie.loadAnimation({
            container: $('stage1'), renderer: 'svg', loop: true, autoplay: true, 
            animationData: JSON.parse(JSON.stringify(originalData)) // Deep copy
          });
          
          $('info1').innerText = `(${originalData.fr || 30} fps)`;
          $('fpsInput').value = originalData.fr || 60;
          $('applyBtn').disabled = false;
          
          hideLoading();
        } catch (err) {
          hideLoading();
          alert('JSON è§£æå¤±è´¥');
        }
      };
      reader.readAsText(f);
    };

    // æ¨¡å¼åˆ‡æ¢
    const modes = document.querySelectorAll('.pill');
    modes.forEach(m => {
      m.onclick = () => {
        modes.forEach(p => p.classList.remove('active'));
        m.classList.add('active');
        const mode = m.dataset.mode;
        $('fpsInput').disabled = (mode === 'fix');
      }
    });

    // åº”ç”¨ä¿®æ”¹
    $('applyBtn').onclick = async () => {
      if (!originalData) return;
      showLoading('å¤„ç†ä¸­...');
      
      // å»¶è¿Ÿä¸€ä¸‹è®© UI æ¸²æŸ“
      await new Promise(r => setTimeout(r, 50));
      
      try {
        processedData = JSON.parse(JSON.stringify(originalData));
        const mode = document.querySelector('.pill.active').dataset.mode;
        const targetFps = parseFloat($('fpsInput').value) || 60;
        const srcFps = processedData.fr || 30;

        // 1. å…ˆä¿®å¤
        const fixedCount = autoFix(processedData);
        if (fixedCount > 0) console.log(`å·²ä¿®å¤ ${fixedCount} ä¸ªå¼‚å¸¸å®½é«˜`);

        // 2. æ ¹æ®æ¨¡å¼å¤„ç†
        if (mode === 'scale') {
          if (targetFps !== srcFps) {
            const ratio = targetFps / srcFps;
            scaleTime(processedData, ratio);
            processedData.fr = targetFps;
          }
        } else if (mode === 'fps') {
          processedData.fr = targetFps;
        }
        
        // 3. æ¸²æŸ“å³ä¾§
        if (anim2) anim2.destroy();
        $('stage2').innerHTML = '';
        anim2 = lottie.loadAnimation({
          container: $('stage2'), renderer: 'svg', loop: true, autoplay: true, 
          animationData: JSON.parse(JSON.stringify(processedData))
        });
        
        $('info2').innerText = `(${processedData.fr} fps)`;
        $('dlBtn').disabled = false;
        $('dlBtn').innerText = `ä¸‹è½½ (${processedData.fr} fps)`;
        
        showToast('å¤„ç†å®Œæˆ');
      } catch (err) {
        console.error(err);
        alert('å¤„ç†å‡ºé”™');
      }
      hideLoading();
    };

    // ä¸‹è½½
    $('dlBtn').onclick = () => {
      const blob = new Blob([JSON.stringify(processedData)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName.replace('.json', '_fixed.json');
      a.click();
    };
    
    // æ‹–æ‹½
    const ub = $('uploadBox');
    ub.ondragover = (e) => { e.preventDefault(); ub.classList.add('dragover'); };
    ub.ondragleave = (e) => { e.preventDefault(); ub.classList.remove('dragover'); };
    ub.ondrop = (e) => {
      e.preventDefault(); ub.classList.remove('dragover');
      if(e.dataTransfer.files.length) {
        $('fileInput').files = e.dataTransfer.files;
        $('fileInput').dispatchEvent(new Event('change'));
      }
    };

  </script>
</body>
</html>
