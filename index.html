<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lottie 帧率修改与预览工具（修正版｜带动画预览）</title>
<style>
  :root { --bg:#0f1115; --fg:#e8eaf0; --muted:#9aa0a6; --card:#171a21; --acc:#5aa9ff; --ok:#33d17a; --warn:#ffb86b; --err:#ff6b6b; --code:#0b0e14; --bd:#222733;}
  html,body{background:var(--bg);color:var(--fg);font:15px/1.55 system-ui,-apple-system,Segoe UI,Roboto,PingFang SC,Noto Sans SC,Helvetica,Arial;}
  .wrap{max-width:1200px;margin:24px auto;padding:0 16px;}
  .card{background:var(--card);border:1px solid var(--bd);border-radius:12px;padding:16px}
  h1{font-size:20px;margin:8px 0 16px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .col{flex:1 1 260px}
  input[type="number"],input[type="text"],input[type="color"]{width:180px;padding:8px 10px;border-radius:8px;border:1px solid #2a3140;background:#11151d;color:#e8eaf0}
  input[type="file"]{accent-color:var(--acc)}
  .btn{appearance:none;cursor:pointer;border:none;border-radius:10px;padding:10px 14px;background:var(--acc);color:#00162a;font-weight:700}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .help{color:var(--muted);font-size:13px}
  .stats{display:grid;grid-template-columns:repeat(4,minmax(120px,1fr));gap:10px;margin-top:10px}
  .stat{background:#121620;border:1px solid var(--bd);border-radius:10px;padding:10px}
  .stat b{display:block;font-size:12px;color:#cfd5e3}
  .stat span{font-size:15px}
  .radio-group{display:grid;gap:8px;margin:10px 0}
  .radio{display:flex;gap:8px;align-items:flex-start}
  .log{white-space:pre-wrap;background:#0c0f15;border:1px dashed #2a3140;border-radius:8px;padding:10px;margin-top:10px;color:#cbd5e1;max-height:220px;overflow:auto}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
  .players{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:16px}
  .player{border:1px solid var(--bd);border-radius:12px;overflow:hidden;background:#0b0f16}
  .player-head{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border-bottom:1px solid var(--bd)}
  .player-title{font-size:14px;color:#cfd5e3}
  .ctrls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .ctrls .btn{padding:6px 10px;font-size:12px}
  .frame{height:280px;display:flex;align-items:center;justify-content:center;background:#0d1118}
  .stage{width:100%;height:100%}
  label{user-select:none}
  .preview-wrap{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:16px}
  .panel{display:flex;flex-direction:column;gap:8px}
  .panel h3{font-size:14px;margin:0;color:#cfd5e3; display:flex; align-items:center; justify-content:space-between;}
  .tools{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .codebox{position:relative;border:1px solid var(--bd);border-radius:10px;background:#0b0e14;padding:10px;max-height:320px;overflow:auto;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12.5px;line-height:1.55}
  .copy{font-size:12px;cursor:pointer;padding:6px 8px;border-radius:8px;border:1px solid var(--bd);background:#0f141d;color:#cfe1ff}
  mark{background:#333a52;color:#d4e0ff;border-radius:3px;padding:0 2px}
  .k{color:#7aa2f7} .s{color:#9ece6a} .n{color:#e0af68} .b{color:#c0caf5} .p{color:#7dcfff}
</style>
<script src="https://cdn.jsdelivr.net/npm/lottie-web@5.12.2/build/player/lottie.min.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>🎞️ Lottie 帧率修改与预览工具（修正版｜带动画预览）</h1>
    <div class="card">
      <div class="row">
        <div class="col">
          <label><b>上传 Lottie JSON</b></label><br/>
          <input id="file" type="file" accept=".json,application/json" />
        </div>
        <div class="col">
          <label><b>目标帧率 (fps)</b></label><br/>
          <input id="targetFr" type="number" min="1" step="1" placeholder="例如 60" />
        </div>
      </div>
      <div class="radio-group">
        <div class="radio"><input type="radio" name="mode" id="mode1" value="just-fr"><label for="mode1"><b>仅修改帧率</b></label></div>
        <div class="radio"><input type="radio" name="mode" id="mode2" value="keep-duration"><label for="mode2"><b>保持整体时长（不缩放关键帧）</b></label></div>
        <div class="radio"><input type="radio" name="mode" id="mode3" value="scale-keyframes" checked><label for="mode3"><b>缩放所有关键帧时间（推荐）</b></label></div>
      </div>
      <div class="stats" id="stats" hidden>
        <div class="stat"><b>当前帧率 fr</b><span id="curFr">-</span></div>
        <div class="stat"><b>开始帧 ip</b><span id="curIp">-</span></div>
        <div class="stat"><b>结束帧 op</b><span id="curOp">-</span></div>
        <div class="stat"><b>当前时长 (秒)</b><span id="curSec">-</span></div>
      </div>
      <div class="row" style="margin-top:14px">
        <button id="run" class="btn" disabled>⚙️ 修改并生成</button>
      </div>
      <div id="log" class="log" style="display:none"></div>

      <div class="players">
        <div class="player">
          <div class="player-head">
            <div class="player-title">改前预览</div>
            <div class="ctrls">
              <button class="btn" id="p1Play">播</button><button class="btn" id="p1Pause">停</button><button class="btn" id="p1Stop">复位</button>
              <label>循环 <input type="checkbox" id="p1Loop" checked></label>
              <label>速度 <input type="number" id="p1Speed" step="0.1" min="0.1" value="1.0" style="width:80px"></label>
              <label>背景 <input type="color" id="p1Bg" value="#0d1118"></label>
            </div>
          </div>
          <div class="frame" id="frame1"><div class="stage" id="stage1"></div></div>
        </div>
        <div class="player">
          <div class="player-head">
            <div class="player-title">改后预览</div>
            <div class="ctrls">
              <button class="btn" id="p2Play">播</button><button class="btn" id="p2Pause">停</button><button class="btn" id="p2Stop">复位</button>
              <label>循环 <input type="checkbox" id="p2Loop" checked></label>
              <label>速度 <input type="number" id="p2Speed" step="0.1" min="0.1" value="1.0" style="width:80px"></label>
              <label>背景 <input type="color" id="p2Bg" value="#0d1118"></label>
            </div>
          </div>
          <div class="frame" id="frame2"><div class="stage" id="stage2"></div></div>
        </div>
      </div>

      <div class="preview-wrap">
        <div class="panel">
          <h3>📄 原始 JSON <span class="tools"><input id="searchLeft" type="text" placeholder="搜索关键字（原始）"/><button class="copy" id="copyLeft">复制</button></span></h3>
          <pre class="codebox" id="codeLeft"></pre>
        </div>
        <div class="panel">
          <h3>🛠️ 处理后 JSON（预览） <span class="tools"><input id="searchRight" type="text" placeholder="搜索关键字（处理后）"/><button class="copy" id="copyRight">复制</button></span></h3>
          <pre class="codebox" id="codeRight"></pre>
        </div>
      </div>
    </div>
  </div>
<script>
(()=>{{
  const $=s=>document.querySelector(s);
  const fileInput=$('#file'), runBtn=$('#run'), targetFrInp=$('#targetFr');
  const statsEl=$('#stats'), curFrEl=$('#curFr'), curIpEl=$('#curIp'), curOpEl=$('#curOp'), curSecEl=$('#curSec');
  const logEl=$('#log'), codeLeft=$('#codeLeft'), codeRight=$('#codeRight'), searchLeft=$('#searchLeft'), searchRight=$('#searchRight');
  const stage1=$('#stage1'), stage2=$('#stage2'), frame1=$('#frame1'), frame2=$('#frame2');
  const p1Play=$('#p1Play'), p1Pause=$('#p1Pause'), p1Stop=$('#p1Stop'), p1Loop=$('#p1Loop'), p1Speed=$('#p1Speed'), p1Bg=$('#p1Bg');
  const p2Play=$('#p2Play'), p2Pause=$('#p2Pause'), p2Stop=$('#p2Stop'), p2Loop=$('#p2Loop'), p2Speed=$('#p2Speed'), p2Bg=$('#p2Bg');

  let originalJsonText='', originalObj=null, processedObj=null, fileName='lottie.json';
  let anim1=null, anim2=null;

  function showLog(m,l=''){{logEl.style.display='block';const p=l==='ok'?'✅ ':l==='warn'?'⚠️ ':l==='err'?'❌ ':'• ';logEl.textContent+=p+m+'\\n';logEl.scrollTop=logEl.scrollHeight;}}
  function resetLog(){{logEl.textContent='';logEl.style.display='none';}}
  function updateStats(o){{try{{const fr=+o.fr,ip=+o.ip,op=+o.op;curFrEl.textContent=Number.isFinite(fr)?fr:'-';curIpEl.textContent=Number.isFinite(ip)?ip:'-';curOpEl.textContent=Number.isFinite(op)?op:'-';const s=(Number.isFinite(fr)&&Number.isFinite(ip)&&Number.isFinite(op)&&fr>0)?(op-ip)/fr:NaN;curSecEl.textContent=Number.isFinite(s)?s.toFixed(4):'-';statsEl.hidden=false;}}catch{{statsEl.hidden=true;}}}}
  function validateReady(){{runBtn.disabled=!(originalObj&&Number(targetFrInp.value)>0);}}
  function escapeHtml(s){{return s.replace(/[&<>"]/g,c=>({{ '&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;' }}[c]));}}
  function highlightJson(text,q){{const h=escapeHtml(text).replace(/(^|\\n)(\\s*)"(.*?)"(\\s*):/g,(m,a,sp,k)=>`${{a}}${{sp}}<span class="k">"${{k}}"</span>:`).replace(/"(?:\\\\.|[^"\\\\])*"/g,m=>`<span class="s">${{m}}</span>`).replace(/\\b-?(?:0|[1-9]\\d*)(?:\\.\\d+)?(?:[eE][+-]?\\d+)?\\b/g,m=>`<span class="n">${{m}}</span>`).replace(/\\b(true|false|null)\\b/g,m=>`<span class="b">${{m}}</span>`).replace(/[\\{{\\}}\\[\\]]/g,m=>`<span class="p">${{m}}</span>`);if(!q)return h;const qq=q.replace(/[.*+?^${{}}()|[\\]\\\\]/g,'\\\\$&');return h.replace(new RegExp(`(${{qq}})`,'ig'),'<mark>$1</mark>');}}
  function renderLeft(t,q=''){{codeLeft.innerHTML=highlightJson(t,q);}}
  function renderRight(o,q=''){{if(!o){{codeRight.textContent='';return;}}const pretty=JSON.stringify(o,null,2);codeRight.innerHTML=highlightJson(pretty,q);}}

  // === 核心：缩放所有时间字段 ===
  function deepClone(obj){{return (window.structuredClone?structuredClone(obj):JSON.parse(JSON.stringify(obj)));}}
  function scaleMarkers(markers,factor){{if(!Array.isArray(markers))return;for(const m of markers){{if(typeof m.tm==='number')m.tm*=factor;if(typeof m.dr==='number')m.dr*=factor;}}}}
  function scaleTimeRemap(tm,factor){{if(!tm)return;if(typeof tm.k==='number'){{tm.k*=factor;return;}}if(Array.isArray(tm.k)){{for(const kf of tm.k){{if(typeof kf.t==='number')kf.t*=factor;if(kf.s){{if(typeof kf.s[0]==='number')kf.s[0]*=factor;}}if(kf.e){{if(typeof kf.e[0]==='number')kf.e[0]*=factor;}}}}}}}
  function scaleAllKeyframeTs(obj,factor){{const stack=[obj];while(stack.length){{const cur=stack.pop();if(!cur)continue;if(Array.isArray(cur)){{for(const v of cur)stack.push(v);continue;}}if(typeof cur==='object'){{if('t'in cur&&typeof cur.t==='number')cur.t*=factor;for(const k in cur){{const v=cur[k];if(k==='tm'&&v)scaleTimeRemap(v,factor);else if(v&&typeof v==='object')stack.push(v);}}}}}}}
  function scaleLayerInOut(layer,factor){{if(typeof layer.ip==='number')layer.ip*=factor;if(typeof layer.op==='number')layer.op*=factor;if(typeof layer.st==='number')layer.st*=factor;if(layer.tm)scaleTimeRemap(layer.tm,factor);}}
  function scaleLayersDeep(layers,factor){{if(!Array.isArray(layers))return;for(const ly of layers){{scaleLayerInOut(ly,factor);if(Array.isArray(ly.layers))scaleLayersDeep(ly.layers,factor);}}}}
  function scaleAllTimings(root,factor){{scaleAllKeyframeTs(root,factor);if(typeof root.ip==='number')root.ip*=factor;if(typeof root.op==='number')root.op*=factor;scaleLayersDeep(root.layers,factor);if(Array.isArray(root.assets)){{for(const a of root.assets){{if(Array.isArray(a.layers))scaleLayersDeep(a.layers,factor);if(typeof a.ip==='number')a.ip*=factor;if(typeof a.op==='number')a.op*=factor;if(typeof a.st==='number')a.st*=factor;}}}}scaleMarkers(root.markers,factor);}}

  // === 文件加载 ===
  fileInput.addEventListener('change',async()=>{resetLog();processedObj=null;renderRight(null);try{{if(!fileInput.files[0])return;const f=fileInput.files[0];fileName=f.name;const txt=await f.text();originalJsonText=txt.trim();originalObj=JSON.parse(txt);renderLeft(JSON.stringify(originalObj,null,2));updateStats(originalObj);showLog('文件已载入:'+fileName,'ok');validateReady();refreshAnims();}}catch(e){{showLog('读取失败:'+e.message,'err');}}}});
  targetFrInp.addEventListener('input',validateReady);

  // === 执行处理 ===
  runBtn.addEvent
