<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lottie å¸§ç‡ä¿®æ”¹ä¸é¢„è§ˆå·¥å…·ï¼ˆä¿®æ­£ç‰ˆï½œé»˜è®¤é¢„è§ˆï½œé€æ˜æ£‹ç›˜èƒŒæ™¯ï¼‰</title>
<style>
  :root{--bg:#0f1115;--fg:#e8eaf0;--muted:#9aa0a6;--card:#171a21;--acc:#5aa9ff;--ok:#33d17a;--warn:#ffb86b;--err:#ff6b6b;--code:#0b0e14;--bd:#222733}
  html,body{background:var(--bg);color:var(--fg);font:15px/1.55 system-ui,-apple-system,Segoe UI,Roboto,PingFang SC,Noto Sans SC,Helvetica,Arial;margin:0}
  .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--bd);border-radius:12px;padding:16px}
  h1{font-size:20px;margin:8px 0 16px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .col{flex:1 1 260px}
  input[type="number"],input[type="text"]{width:180px;padding:8px 10px;border-radius:8px;border:1px solid #2a3140;background:#11151d;color:var(--fg)}
  input[type="file"]{accent-color:var(--acc)}
  .btn{appearance:none;cursor:pointer;border:none;border-radius:10px;padding:10px 14px;background:var(--acc);color:#00162a;font-weight:700}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .help{color:var(--muted);font-size:13px}
  .stats{display:grid;grid-template-columns:repeat(4,minmax(120px,1fr));gap:10px;margin-top:10px}
  .stat{background:#121620;border:1px solid var(--bd);border-radius:10px;padding:10px}
  .stat b{display:block;font-size:12px;color:#cfd5e3}
  .log{white-space:pre-wrap;background:#0c0f15;border:1px dashed #2a3140;border-radius:8px;padding:10px;margin-top:10px;color:#cbd5e1;max-height:220px;overflow:auto}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
  .preview-wrap{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:16px}
  .panel{display:flex;flex-direction:column;gap:8px}
  .panel h3{font-size:14px;margin:0;color:#cfd5e3;display:flex;align-items:center;justify-content:space-between}
  .tools{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .codebox{border:1px solid var(--bd);border-radius:10px;background:#0b0e14;padding:10px;max-height:340px;overflow:auto;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12.5px;line-height:1.55}
  .copy{font-size:12px;cursor:pointer;padding:6px 8px;border-radius:8px;border:1px solid var(--bd);background:#0f141d;color:#cfe1ff}
  mark{background:#333a52;color:#d4e0ff;border-radius:3px;padding:0 2px}
  .k{color:#7aa2f7}.s{color:#9ece6a}.n{color:#e0af68}.b{color:#c0caf5}.p{color:#7dcfff}

  /* é¢„è§ˆæ’­æ”¾å™¨ */
  .players{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:16px}
  .player{border:1px solid var(--bd);border-radius:12px;overflow:hidden;background:#0b0f16}
  .player-head{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border-bottom:1px solid var(--bd)}

  /* âœ… é€æ˜æ£‹ç›˜æ ¼èƒŒæ™¯ï¼ˆä¸å‚è€ƒå›¾ä¸€è‡´ï¼‰ */
  .frame{
    height:280px; display:flex; align-items:center; justify-content:center;
    background-image:
      linear-gradient(45deg, #e9ecef 25%, transparent 25%, transparent 75%, #e9ecef 75%, #e9ecef),
      linear-gradient(45deg, #f7f8fa 25%, transparent 25%, transparent 75%, #f7f8fa 75%, #f7f8fa);
    background-size: 20px 20px;
    background-position: 0 0, 10px 10px;
  }
  .stage{width:100%;height:100%; background:transparent}
</style>
<script src="https://cdn.jsdelivr.net/npm/lottie-web@5.12.2/build/player/lottie.min.js"></script>
</head>
<body>
<div class="wrap">
  <h1>ğŸï¸ Lottie å¸§ç‡ä¿®æ”¹ä¸é¢„è§ˆå·¥å…·ï¼ˆä¿®æ­£ç‰ˆï½œé»˜è®¤é¢„è§ˆï½œé€æ˜æ£‹ç›˜èƒŒæ™¯ï¼‰</h1>
  <div class="card">
    <div class="row">
      <div class="col">
        <label><b>ä¸Šä¼  Lottie JSON</b></label><br/>
        <input id="file" type="file" accept=".json,application/json" />
        <div class="help">ä»…åœ¨æµè§ˆå™¨æœ¬åœ°å¤„ç†ï¼Œä¸ä¼šä¸Šä¼ æœåŠ¡å™¨ã€‚</div>
      </div>
      <div class="col">
        <label><b>ç›®æ ‡å¸§ç‡ (fps)</b></label><br/>
        <input id="targetFr" type="number" min="1" step="1" placeholder="ä¾‹å¦‚ 60" />
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <label><input type="radio" name="mode" value="just-fr"> ä»…ä¿®æ”¹å¸§ç‡</label>
      <label><input type="radio" name="mode" value="keep-duration"> ä¿æŒæ•´ä½“æ—¶é•¿</label>
      <label><input type="radio" name="mode" value="scale-keyframes" checked> ç¼©æ”¾æ‰€æœ‰å…³é”®å¸§æ—¶é—´ï¼ˆæ¨èï¼‰</label>
    </div>

    <div class="stats" id="stats" hidden>
      <div class="stat"><b>å½“å‰ fr</b><div id="curFr">-</div></div>
      <div class="stat"><b>å¼€å§‹å¸§ ip</b><div id="curIp">-</div></div>
      <div class="stat"><b>ç»“æŸå¸§ op</b><div id="curOp">-</div></div>
      <div class="stat"><b>æ—¶é•¿(ç§’)</b><div id="curSec">-</div></div>
    </div>

    <div class="row" style="margin-top:14px">
      <button id="run" class="btn" disabled>âš™ï¸ ä¿®æ”¹å¹¶ç”Ÿæˆ</button>
    </div>

    <div id="log" class="log" style="display:none"></div>

    <div class="players">
      <div class="player">
        <div class="player-head">
          <div>æ”¹å‰é¢„è§ˆ</div>
          <div>
            <button class="btn" id="p1Play">æ’­</button>
            <button class="btn" id="p1Pause">åœ</button>
            <button class="btn" id="p1Stop">å¤ä½</button>
          </div>
        </div>
        <div class="frame"><div class="stage" id="stage1"></div></div>
      </div>
      <div class="player">
        <div class="player-head">
          <div>æ”¹åé¢„è§ˆ</div>
          <div>
            <button class="btn" id="p2Play">æ’­</button>
            <button class="btn" id="p2Pause">åœ</button>
            <button class="btn" id="p2Stop">å¤ä½</button>
          </div>
        </div>
        <div class="frame"><div class="stage" id="stage2"></div></div>
      </div>
    </div>

    <div class="preview-wrap">
      <div class="panel">
        <h3>ğŸ“„ åŸå§‹ JSON <span class="tools"><input id="searchLeft" type="text" placeholder="æœç´¢åŸå§‹"/><button class="copy" id="copyLeft">å¤åˆ¶</button></span></h3>
        <pre class="codebox" id="codeLeft"></pre>
      </div>
      <div class="panel">
        <h3>ğŸ› ï¸ å¤„ç†å JSON <span class="tools"><input id="searchRight" type="text" placeholder="æœç´¢å¤„ç†å"/><button class="copy" id="copyRight">å¤åˆ¶</button></span></h3>
        <pre class="codebox" id="codeRight"></pre>
      </div>
    </div>
  </div>
</div>

<script>
(()=> {
  const $ = s => document.querySelector(s);
  const fileInput=$('#file'), runBtn=$('#run'), targetFrInp=$('#targetFr');
  const statsEl=$('#stats'),curFrEl=$('#curFr'),curIpEl=$('#curIp'),curOpEl=$('#curOp'),curSecEl=$('#curSec');
  const logEl=$('#log'), codeLeft=$('#codeLeft'), codeRight=$('#codeRight');
  const searchLeft=$('#searchLeft'), searchRight=$('#searchRight');
  const stage1=$('#stage1'), stage2=$('#stage2');
  const p1Play=$('#p1Play'), p1Pause=$('#p1Pause'), p1Stop=$('#p1Stop');
  const p2Play=$('#p2Play'), p2Pause=$('#p2Pause'), p2Stop=$('#p2Stop');
  let anim1=null,anim2=null;
  let originalJsonText='', originalObj=null, processedObj=null, fileName='lottie.json';

  function showLog(m,l=''){logEl.style.display='block';const p=l==='ok'?'âœ… ':l==='warn'?'âš ï¸ ':l==='err'?'âŒ ':'â€¢ ';logEl.textContent+=p+m+'\\n';logEl.scrollTop=logEl.scrollHeight;}
  function resetLog(){logEl.textContent='';logEl.style.display='none';}
  function updateStats(o){try{const fr=+o.fr,ip=+o.ip,op=+o.op;curFrEl.textContent=fr;curIpEl.textContent=ip;curOpEl.textContent=op;curSecEl.textContent=((op-ip)/fr).toFixed(3);statsEl.hidden=false;}catch{statsEl.hidden=true;}}
  function validateReady(){runBtn.disabled=!(originalObj&&Number(targetFrInp.value)>0);}
  function escapeHtml(s){return s.replace(/[&<>"]/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]));}
  function highlightJson(text,q){const h=escapeHtml(text).replace(/(^|\\n)(\\s*)"(.*?)"(\\s*):/g,(m,a,sp,k)=>`${a}${sp}<span class="k">"${k}"</span>:`).replace(/"(?:\\\\.|[^"\\\\])*"/g,m=>`<span class="s">${m}</span>`).replace(/\\b-?(?:0|[1-9]\\d*)(?:\\.\\d+)?(?:[eE][+-]?\\d+)?\\b/g,m=>`<span class="n">${m}</span>`).replace(/\\b(true|false|null)\\b/g,m=>`<span class="b">${m}</span>`).replace(/[\\{\\}\\[\\]]/g,m=>`<span class="p">${m}</span>`);if(!q)return h;const qq=q.replace(/[.*+?^${}()|[\\]\\\\]/g,'\\\\$&');return h.replace(new RegExp(`(${qq})`,'ig'),'<mark>$1</mark>');}
  function renderLeft(t,q=''){codeLeft.innerHTML=highlightJson(t,q);}
  function renderRight(o,q=''){if(!o){codeRight.textContent='';return;}codeRight.innerHTML=highlightJson(JSON.stringify(o,null,2),q);}

  // === ç¼©æ”¾æ—¶é—´è½´ ===
  const deepClone=o=>(window.structuredClone?structuredClone(o):JSON.parse(JSON.stringify(o)));
  function scaleMarkers(ms,f){if(!Array.isArray(ms))return;for(const m of ms){if(typeof m.tm==='number')m.tm*=f;if(typeof m.dr==='number')m.dr*=f;}}
  function scaleTimeRemap(tm,f){if(!tm)return;if(typeof tm.k==='number'){tm.k*=f;return;}if(Array.isArray(tm.k)){for(const kf of tm.k){if(kf && typeof kf.t==='number')kf.t*=f;if(kf && kf.s!=null){if(typeof kf.s==='number')kf.s*=f;else if(Array.isArray(kf.s)&&typeof kf.s[0]==='number')kf.s[0]*=f;}if(kf && kf.e!=null){if(typeof kf.e==='number')kf.e*=f;else if(Array.isArray(kf.e)&&typeof kf.e[0]==='number')kf.e[0]*=f;}}}}
  function scaleAllKeyframeTs(obj,f){const st=[obj];while(st.length){const cur=st.pop();if(!cur)continue;if(Array.isArray(cur)){for(const v of cur)st.push(v);continue;}if(typeof cur==='object'){if('t'in cur&&typeof cur.t==='number'){const looksKF=('s'in cur)||('e'in cur)||('h'in cur)||('i'in cur)||('o'in cur)||('hold'in cur)||('k'in cur);if(looksKF)cur.t*=f;}for(const k in cur){const v=cur[k];if(k==='tm'&&v&&typeof v==='object')scaleTimeRemap(v,f);else if(v&&typeof v==='object')st.push(v);}}}}
  function scaleLayerInOut(l,f){if(typeof l?.ip==='number')l.ip*=f;if(typeof l?.op==='number')l.op*=f;if(typeof l?.st==='number')l.st*=f;if(l&&l.tm)scaleTimeRemap(l.tm,f);}
  function scaleLayersDeep(ls,f){if(!Array.isArray(ls))return;for(const ly of ls){scaleLayerInOut(ly,f);if(Array.isArray(ly?.layers))scaleLayersDeep(ly.layers,f);}}
  function scaleAllTimings(root,f){scaleAllKeyframeTs(root,f);if(typeof root.ip==='number')root.ip*=f;if(typeof root.op==='number')root.op*=f;scaleLayersDeep(root.layers,f);if(Array.isArray(root.assets)){for(const a of root.assets){if(Array.isArray(a.layers))scaleLayersDeep(a.layers,f);if(typeof a.ip==='number')a.ip*=f;if(typeof a.op==='number')a.op*=f;if(typeof a.st==='number')a.st*=f;}}scaleMarkers(root.markers,f);}

  // === æ’­æ”¾å™¨ ===
  function loadAnim(container, data){
    container.innerHTML='';
    // ç¡®ä¿å®¹å™¨é€æ˜ï¼ˆé¿å…è¢«å¤–å±‚æ ·å¼è¦†ç›–ï¼‰
    container.style.background = 'transparent';
    return lottie.loadAnimation({container, renderer:'svg', loop:true, autoplay:true, animationData:data});
  }
  function refreshPlayers(){
    if(originalObj){ if(anim1) anim1.destroy(); anim1 = loadAnim(stage1, originalObj); }
    if(processedObj){ if(anim2) anim2.destroy(); anim2 = loadAnim(stage2, processedObj); }
  }

  // === äº‹ä»¶ ===
  fileInput.addEventListener('change', async ()=>{
    resetLog();
    try{
      const f=fileInput.files[0]; if(!f) return;
      fileName=f.name;
      originalJsonText=await f.text();
      originalObj=JSON.parse(originalJsonText);
      renderLeft(JSON.stringify(originalObj,null,2));
      updateStats(originalObj);
      showLog('æ–‡ä»¶å·²è½½å…¥ï¼š'+fileName,'ok');
      validateReady();
      refreshPlayers();
    }catch(e){ showLog('è¯»å–å¤±è´¥ï¼š'+(e?.message||e),'err'); }
  });
  targetFrInp.addEventListener('input', validateReady);

  runBtn.addEventListener('click', ()=>{
    resetLog();
    if(!originalObj){ showLog('è¯·å…ˆä¸Šä¼ ','err'); return; }
    const newFr=+targetFrInp.value;
    const mode=document.querySelector('input[name="mode"]:checked').value;
    const obj=deepClone(originalObj);
    const oldFr=+obj.fr; const hadFr=Number.isFinite(oldFr)&&oldFr>0;
    const ip=+obj.ip, op=+obj.op; const hadRange=Number.isFinite(ip)&&Number.isFinite(op);
    const factor = hadFr ? newFr/oldFr : 1;
    try{
      if(mode==='just-fr'){
        obj.fr=newFr;
      }else if(mode==='keep-duration'){
        obj.fr=newFr;
        if(hadRange){ const secs=(op-ip)/(hadFr?oldFr:newFr); obj.op = ip + secs*newFr; }
        const rf = (hadFr?newFr/oldFr:1);
        if(Array.isArray(obj.layers)){ for(const ly of obj.layers){ if(typeof ly.ip==='number') ly.ip*=rf; if(typeof ly.op==='number') ly.op*=rf; if(typeof ly.st==='number') ly.st*=rf; } }
        if(Array.isArray(obj.assets)){ for(const a of obj.assets){ if(Array.isArray(a.layers)){ for(const ly of a.layers){ if(typeof ly.ip==='number') ly.ip*=rf; if(typeof ly.op==='number') ly.op*=rf; if(typeof ly.st==='number') ly.st*=rf; } } } }
        if(Array.isArray(obj.markers)){ for(const m of obj.markers){ if(typeof m.tm==='number') m.tm*=rf; if(typeof m.dr==='number') m.dr*=rf; } }
      }else{ // scale-keyframes
        obj.fr=newFr;
        if(hadFr){ scaleAllTimings(obj, factor); }
        else { showLog('æœªæ£€æµ‹åˆ°æ—§å¸§ç‡ï¼Œä»…è®¾ç½® frã€‚','warn'); }
      }

      processedObj=obj;
      renderRight(obj, searchRight.value);
      updateStats(obj);
      refreshPlayers();

      // ä¸‹è½½
      const outName=(fileName||'lottie.json').replace(/\.json$/i,'')+`-fr${newFr}${mode==='scale-keyframes'?'-scaled':mode==='keep-duration'?'-keepdur':''}.json`;
      const blob=new Blob([JSON.stringify(obj,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=outName; a.click(); URL.revokeObjectURL(url);
      showLog('å¤„ç†å®Œæˆï¼š'+outName,'ok');
    }catch(e){ showLog('å¤„ç†å¤±è´¥ï¼š'+(e?.message||e),'err'); }
  });

  searchLeft.addEventListener('input', ()=>{ try{ renderLeft(JSON.stringify(JSON.parse(originalJsonText||'{}'),null,2), searchLeft.value); }catch{} });
  searchRight.addEventListener('input', ()=> renderRight(processedObj, searchRight.value) );
})();
</script>
</body>
</html>
